name: Ultimate Shell Build
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # گام ۱: نصب پیش نیازهای سیستمی و پایتون
      - name: Install System Dependencies and Buildozer
        run: |
          sudo apt update
          sudo apt install -y python3-pip openjdk-17-jdk git build-essential unzip
          pip3 install buildozer cython==0.29.33 arabic-reshaper python-bidi
          
      # گام ۲: نصب ابزارهای اندروید (Android SDK/NDK) به صورت دستی
      - name: Setup Android Environment (Manual)
        run: |
          # مسیرهای محلی برای نصب
          mkdir -p ~/.buildozer/android/platform/android-sdk
          export ANDROIDSDK=~/.buildozer/android/platform/android-sdk
          export ANDROIDNDK=~/.buildozer/android/platform/android-ndk
          
          # دانلود Command Line Tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-8504014_latest.zip -O android_tools.zip
          unzip android_tools.zip -d "$ANDROIDSDK"
          
          # پذیرش لایسنس ها و نصب پلتفرم اندروید 30
          yes | "$ANDROIDSDK/cmdline-tools/bin/sdkmanager" "platform-tools" "platforms;android-30"
          
          # دانلود NDK مورد نیاز Buildozer (نسخه 21e)
          wget https://dl.google.com/android/repository/android-ndk-r21e-linux.zip -O android_ndk.zip
          unzip android_ndk.zip -d "$ANDROIDNDK/.."
          mv "$ANDROIDNDK/android-ndk-r21e" "$ANDROIDNDK/android-ndk-21e"
          
          # ثبت متغیرهای محیطی برای گام های بعدی (رفع خطای exit code 8)
          echo "ANDROIDSDK=$ANDROIDSDK" >> $GITHUB_ENV
          echo "ANDROIDNDK=$ANDROIDNDK/android-ndk-21e" >> $GITHUB_ENV
          
          # افزودن مسیر ابزارهای سیستمی به PATH
          echo "$ANDROIDSDK/platform-tools" >> $GITHUB_PATH
          
      # گام ۳: اجرای Buildozer
      - name: Run Buildozer (Final Build)
        run: |
          buildozer android debug
          
      # گام ۴: آپلود
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kivy-Sarf-App
          path: bin/*.apk
