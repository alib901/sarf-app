name: Ultimate Shell Build (Final)
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # گام ۱: نصب پیش نیازهای سیستمی و پایتون
      - name: Install System Dependencies and Buildozer
        run: |
          sudo apt update
          # نصب Java 17 و ابزارهای ضروری
          sudo apt install -y python3-pip openjdk-17-jdk git build-essential unzip
          # نصب Buildozer و کتابخانه های فارسی
          pip3 install buildozer cython==0.29.33 arabic-reshaper python-bidi
          
      # گام ۲: نصب اندروید و اجرای Buildozer (همه در یک Shell)
      - name: Setup Android and Run Buildozer (Single Step)
        run: |
          # تعریف مسیرهای مطلق
          export ANDROIDSDK=/home/runner/.buildozer/android/platform/android-sdk
          export ANDROIDNDK=/home/runner/.buildozer/android/platform/android-ndk
          
          # ساخت دایرکتوری ها
          mkdir -p $ANDROIDSDK
          mkdir -p $ANDROIDNDK
          
          # دانلود و نصب SDK Command Line Tools
          wget https://dl.google.com/android/repository/commandlinetools-linux-8504014_latest.zip -O android_tools.zip
          unzip android_tools.zip -d "$ANDROIDSDK"
          
          # پذیرش لایسنس ها و نصب پلتفرم اندروید 30
          yes | "$ANDROIDSDK/cmdline-tools/bin/sdkmanager" "platform-tools" "platforms;android-30"
          
          # دانلود و نصب NDK (نسخه 21e)
          wget https://dl.google.com/android/repository/android-ndk-r21e-linux.zip -O android_ndk.zip
          unzip android_ndk.zip -d "$ANDROIDNDK/.."
          mv "$ANDROIDNDK/android-ndk-r21e" "$ANDROIDNDK/android-ndk-21e"
          
          # *اجرای نهایی Buildozer در همین Shell*
          # Buildozer متغیرهای ANDROIDSDK و ANDROIDNDK را به صورت محلی می بیند
          buildozer android debug
          
      # گام ۳: آپلود Artifact
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kivy-Sarf-App
          path: bin/*.apk
