name: Ultimate Shell Build (Final Integrated)
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # گام ۱: پاکسازی و نصب تمام پیش‌نیازها (SDK، NDK و Buildozer) در یک Shell واحد
      - name: Full Setup and Build (Integrated)
        run: |
          # 1. پاکسازی و نصب پیش نیازها
          rm -rf .buildozer/
          sudo apt update
          sudo apt install -y python3-pip openjdk-17-jdk git build-essential unzip
          
          # 2. نصب Buildozer در مسیر فعلی (و اطمینان از دسترسی)
          pip3 install buildozer cython==0.29.33 arabic-reshaper python-bidi
          
          # 3. تعریف مسیرهای مطلق (جایگزین HOME Dir)
          export ANDROIDSDK=/home/runner/.buildozer/android/platform/android-sdk
          export ANDROIDNDK=/home/runner/.buildozer/android/platform/android-ndk
          
          # 4. نصب SDK و NDK
          mkdir -p $ANDROIDSDK
          mkdir -p $ANDROIDNDK
          
          wget https://dl.google.com/android/repository/commandlinetools-linux-8504014_latest.zip -O android_tools.zip
          unzip android_tools.zip -d "$ANDROIDSDK"
          yes | "$ANDROIDSDK/cmdline-tools/bin/sdkmanager" "platform-tools" "platforms;android-30"
          
          wget https://dl.google.com/android/repository/android-ndk-r21e-linux.zip -O android_ndk.zip
          unzip android_ndk.zip -d "$ANDROIDNDK/.."
          mv "$ANDROIDNDK/android-ndk-r21e" "$ANDROIDNDK/android-ndk-21e"
          
          # 5. اجرای نهایی Buildozer در همین Shell
          # از آنجایی که buildozer در همین گام نصب شد، PATH برایش معتبر است.
          buildozer android debug
          
      # گام ۲: آپلود Artifact
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Kivy-Sarf-App
          path: bin/*.apk
